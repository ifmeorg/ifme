version: 2.0
jobs:
  build:
    docker:
      - image: circleci/ruby:2.3.4
      - image: circleci/node:8.11.1
    steps:
      - checkout
      - save_cache:
          key: dependency-cache
          paths:
            - ~/.cache/yarn
      - run: curl -L -o google-chrome.deb
        https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
      - run: sudo dpkg -i google-chrome.deb
      - run: sudo sed -i 's|HERE/chrome\"|HERE/chrome\"
        --disable-setuid-sandbox|g' /opt/google/chrome/google-chrome
      - run: rm google-chrome.deb
      - run: gem install bundler
      - run: bundle install --path=vendor/bundle --jobs=4 --retry=3
      - run: yarn

  test:
    docker:
      - image: circleci/ruby:2.3.4
      - image: circleci/node:8.11.1
    steps:
      - checkout
      - run: bundle exec rspec --format progress --format RspecJunitFormatter -o
          $CIRCLE_TEST_REPORTS/rspec.xml
      - run: RAILS_ENV=test bundle exec rake jasmine:ci
      - run: bundle exec bundle-audit check --update
      - run: RAILS_ENV=test bundle exec rake db:create db:schema:load
      - run: cd client &&
        RAILS_ENV=test bundle exec rake react_on_rails:locale &&
        yarn lint:setup && yarn lint && yarn build:test && yarn test

deployment:
  staging:
    branch: master
    heroku:
      appname: ifme
